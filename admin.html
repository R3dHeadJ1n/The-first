<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #fff5e6;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        
        body.login-mode {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-container h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .error-message {
            color: #d32f2f;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }

        .admin-content {
            display: none;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            margin: 0 auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            color: #333;
        }

        .logout-btn {
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background-color: #da190b;
        }

        .admin-panel-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .admin-panel-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .admin-panel-section select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .admin-panel-section select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .admin-panel-section input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .admin-panel-section input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .admin-buttons button {
            flex: 1;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .admin-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
        }

        .admin-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .admin-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .admin-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .restart-btn:hover {
            background-color: #f57c00 !important;
        }

        .bookings-list {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .bookings-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bookings-list h2 {
            color: #333;
            margin: 0;
        }

        .booking-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-info {
            flex: 1;
        }

        .booking-info strong {
            color: #333;
            font-size: 16px;
        }

        .booking-info .room-name {
            text-transform: uppercase;
            font-weight: bold;
        }

        .booking-info .dates {
            color: #666;
            margin-top: 5px;
        }

        .booking-delete-btn {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .booking-delete-btn:hover {
            background-color: #da190b;
        }

        .booking-confirm-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .booking-confirm-btn:hover {
            background-color: #45a049;
        }

        .booking-actions {
            display: flex;
            gap: 10px;
        }

        .unconfirmed-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .unconfirmed-section-header h2 {
            margin: 0;
        }

        .unconfirmed-header-buttons {
            display: flex;
            gap: 10px;
        }

        .server-status {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .server-status.online {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .server-status.offline {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background-color: #28a745;
        }

        .status-indicator.offline {
            background-color: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .no-bookings {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fff5e6;
            margin: 15% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Login Form (shown when not authenticated) -->
    <div id="loginContainer" class="login-container">
        <h2>Admin Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn">Login</button>
            <div id="errorMessage" class="error-message"></div>
        </form>
    </div>

    <!-- Admin Content (shown when authenticated) -->
    <div id="adminContent" class="admin-content">
        <div class="admin-header">
            <h1>Admin Panel</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="serverStatus" class="server-status" style="padding: 8px 15px; border-radius: 4px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <span class="status-indicator" style="width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; display: inline-block;"></span>
                    <span class="status-text">Checking...</span>
                </div>
                <button class="btn" id="menuBtn" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">MENU</button>
                <button class="restart-btn" id="restartBtn" style="background-color: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Restart Backend</button>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>
        
        <div class="admin-panel-section">
            <h2>Manage Room Availability</h2>
            
            <div class="form-group">
                <label for="adminRoomSelect">Select Room:</label>
                <select id="adminRoomSelect" required>
                    <option value="">-- Select Room --</option>
                    <optgroup label="Big Rooms">
                        <option value="big-1">Big Room 1</option>
                        <option value="big-2">Big Room 2</option>
                        <option value="big-3">Big Room 3</option>
                    </optgroup>
                    <optgroup label="Small Rooms">
                        <option value="small-1">Small Room 1</option>
                        <option value="small-2">Small Room 2</option>
                        <option value="small-3">Small Room 3</option>
                        <option value="small-4">Small Room 4</option>
                        <option value="small-5">Small Room 5</option>
                        <option value="small-6">Small Room 6</option>
                        <option value="small-7">Small Room 7</option>
                        <option value="small-8">Small Room 8</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="form-group">
                <label for="adminCheckIn">Check-in Date:</label>
                <input type="text" id="adminCheckIn" placeholder="Select check-in date" readonly>
            </div>
            
            <div class="form-group">
                <label for="adminCheckOut">Check-out Date:</label>
                <input type="text" id="adminCheckOut" placeholder="Select check-out date" readonly>
            </div>
            
            <div class="admin-buttons">
                <button type="button" id="adminSaveBtn" class="btn">Mark as Unavailable</button>
            </div>
            
            <div id="adminMessage" class="admin-message"></div>
        </div>
        
        <div class="admin-panel-section">
            <div class="unconfirmed-section-header">
                <h2>Unconfirmed Bookings</h2>
                <div class="unconfirmed-header-buttons" id="unconfirmedBulkButtons" style="display: none;">
                    <button type="button" class="booking-confirm-btn" onclick="confirmAllUnconfirmedBookings()">Confirm All</button>
                    <button type="button" class="booking-delete-btn" onclick="deleteAllUnconfirmedBookings()">Delete All</button>
                </div>
            </div>
            <div id="unconfirmedBookingsList">
                <div class="no-bookings">Loading unconfirmed bookings...</div>
            </div>
        </div>

        <!-- Room Selection Modal -->
        <div id="roomSelectionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Select Room for Booking</h2>
                <div id="roomSelectionInfo" style="margin-bottom: 20px;"></div>
                <div class="form-group">
                    <label for="roomSelect">Available Rooms:</label>
                    <select id="roomSelect" style="width: 100%; padding: 10px; font-size: 16px;">
                        <option value="">Loading rooms...</option>
                    </select>
                </div>
                <div class="admin-buttons" style="margin-top: 20px;">
                    <button type="button" id="confirmRoomBtn" class="btn">Confirm Booking</button>
                    <button type="button" id="cancelRoomBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div class="bookings-list">
            <div class="bookings-list-header">
                <h2>All Admin Bookings</h2>
                <button type="button" id="deleteAllAdminBtn" class="booking-delete-btn" onclick="deleteAllAdminBookings()" style="display: none;">Delete All</button>
            </div>
            <div id="bookingsList">
                <div class="no-bookings">Loading bookings...</div>
            </div>
        </div>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script>
        // Admin credentials
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin';
        
        // Storage key for authentication
        const AUTH_KEY = 'admin_authenticated';
        const BACKEND_URL = 'http://localhost:3001';
        
        let adminCheckInPicker = null;
        let adminCheckOutPicker = null;

        // Check authentication status on page load
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem(AUTH_KEY) === 'true';
            
            if (isAuthenticated) {
                showAdminContent();
            } else {
                showLoginForm();
            }
        }

        function showLoginForm() {
            document.body.classList.add('login-mode');
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
        }

        function showAdminContent() {
            document.body.classList.remove('login-mode');
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            // Initialize admin panel after showing content
            setTimeout(() => {
                initAdminPanel();
                loadBookings();
                loadUnconfirmedBookings();
                checkServerStatus(); // Check server status on load/refresh
            }, 100);
        }

        // Initialize admin date pickers
        function initAdminPanel() {
            const checkInInput = document.getElementById('adminCheckIn');
            const checkOutInput = document.getElementById('adminCheckOut');
            
            if (!checkInInput || !checkOutInput) return;
            
            if (!adminCheckInPicker) {
                adminCheckInPicker = flatpickr(checkInInput, {
                    dateFormat: 'Y-m-d',
                    minDate: 'today',
                    enableTime: false,
                    onChange: function(selectedDates, dateStr) {
                        // Update check-out minimum date when check-in changes
                        if (selectedDates.length > 0 && adminCheckOutPicker) {
                            const nextDay = new Date(selectedDates[0]);
                            nextDay.setDate(nextDay.getDate() + 1);
                            adminCheckOutPicker.set('minDate', nextDay);
                        }
                    }
                });
            }
            
            if (!adminCheckOutPicker) {
                adminCheckOutPicker = flatpickr(checkOutInput, {
                    dateFormat: 'Y-m-d',
                    minDate: 'today',
                    enableTime: false
                });
            }
        }

        // Format Date object to YYYY-MM-DD string (preserves local date, no UTC conversion)
        function formatDateForBackend(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Format date from YYYY-MM-DD to DD.MM.YY
        function formatDate(dateStr) {
            // Parse date string directly to avoid timezone issues
            const parts = dateStr.split('-');
            if (parts.length !== 3) {
                // Fallback to Date object if format is unexpected
                const date = new Date(dateStr + 'T00:00:00');
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                return `${day}.${month}.${year}`;
            }
            const year = parts[0].slice(-2); // Last 2 digits of year
            const month = parts[1];
            const day = parts[2];
            return `${day}.${month}.${year}`;
        }

        // Format room name (big-1 -> BIG ROOM#1)
        function formatRoomName(roomId) {
            if (!roomId) return 'Unknown';
            const parts = roomId.split('-');
            const type = parts[0].toUpperCase();
            const num = parts[1];
            return `${type} ROOM#${num}`;
        }

        // Load and display bookings
        async function loadBookings() {
            const bookingsList = document.getElementById('bookingsList');
            if (!bookingsList) return;

            try {
                console.log('Loading bookings from:', `${BACKEND_URL}/admin/bookings`);
                const response = await fetch(`${BACKEND_URL}/admin/bookings`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to load bookings:', response.status, errorText);
                    bookingsList.innerHTML = `<div class="no-bookings">Error loading bookings (${response.status}). Check console for details.</div>`;
                    const deleteAllBtn = document.getElementById('deleteAllAdminBtn');
                    if (deleteAllBtn) deleteAllBtn.style.display = 'none';
                    return;
                }

                const bookings = await response.json();
                
                if (bookings.length === 0) {
                    bookingsList.innerHTML = '<div class="no-bookings">No bookings found</div>';
                    const deleteAllBtn = document.getElementById('deleteAllAdminBtn');
                    if (deleteAllBtn) deleteAllBtn.style.display = 'none';
                    return;
                }

                const deleteAllBtn = document.getElementById('deleteAllAdminBtn');
                if (deleteAllBtn) deleteAllBtn.style.display = 'inline-block';

                // Sort bookings by check-in date, then by room
                bookings.sort((a, b) => {
                    if (a.checkIn !== b.checkIn) {
                        return a.checkIn.localeCompare(b.checkIn);
                    }
                    return a.roomId.localeCompare(b.roomId);
                });

                // Display bookings
                let bookingNumber = 1;
                bookingsList.innerHTML = bookings.map(booking => {
                    const roomName = formatRoomName(booking.roomId);
                    const checkInFormatted = formatDate(booking.checkIn);
                    const checkOutFormatted = formatDate(booking.checkOut);
                    const dateRange = checkInFormatted === checkOutFormatted 
                        ? checkInFormatted 
                        : `${checkInFormatted}-${checkOutFormatted}`;
                    
                    return `
                        <div class="booking-item">
                            <div class="booking-info">
                                <strong>BOOKING #${bookingNumber++}:</strong> 
                                <span class="room-name">${roomName}</span> 
                                <span class="dates">${dateRange}</span>
                            </div>
                            <button class="booking-delete-btn" onclick="deleteBooking('${booking.id}')">Delete</button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading bookings:', error);
                bookingsList.innerHTML = `<div class="no-bookings">Error loading bookings: ${error.message}. Make sure backend server is running on port 3001.</div>`;
                const deleteAllBtn = document.getElementById('deleteAllAdminBtn');
                if (deleteAllBtn) deleteAllBtn.style.display = 'none';
            }
        }

        // Load and display unconfirmed bookings
        async function loadUnconfirmedBookings() {
            const unconfirmedList = document.getElementById('unconfirmedBookingsList');
            if (!unconfirmedList) return;

            try {
                console.log('Loading unconfirmed bookings from:', `${BACKEND_URL}/admin/unconfirmed-bookings`);
                const response = await fetch(`${BACKEND_URL}/admin/unconfirmed-bookings`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to load unconfirmed bookings:', response.status, errorText);
                    unconfirmedList.innerHTML = `<div class="no-bookings">Error loading unconfirmed bookings (${response.status}).</div>`;
                    const bulkBtns = document.getElementById('unconfirmedBulkButtons');
                    if (bulkBtns) bulkBtns.style.display = 'none';
                    return;
                }

                const bookings = await response.json();
                
                if (bookings.length === 0) {
                    unconfirmedList.innerHTML = '<div class="no-bookings">No unconfirmed bookings</div>';
                    document.getElementById('unconfirmedBulkButtons').style.display = 'none';
                    return;
                }

                document.getElementById('unconfirmedBulkButtons').style.display = 'flex';

                // Display unconfirmed bookings
                unconfirmedList.innerHTML = bookings.map(booking => {
                    const roomTypeText = booking.roomType === 'big' ? 'Big Room' : 'Small Room';
                    const checkInFormatted = formatDate(booking.checkIn);
                    const checkOutFormatted = formatDate(booking.checkOut);
                    const dateRange = checkInFormatted === checkOutFormatted 
                        ? checkInFormatted 
                        : `${checkInFormatted}-${checkOutFormatted}`;
                    
                    return `
                        <div class="booking-item">
                            <div class="booking-info">
                                <strong>${roomTypeText}</strong><br>
                                <span class="dates">${dateRange}</span><br>
                                <span>Guests: ${booking.guests}</span><br>
                                <span>Phone: ${booking.phone}</span>
                            </div>
                            <div class="booking-actions">
                                <button class="booking-confirm-btn" onclick="showRoomSelection('${booking.id}', '${booking.roomType}', '${booking.checkIn}', '${booking.checkOut}')">Confirm</button>
                                <button class="booking-delete-btn" onclick="deleteUnconfirmedBooking('${booking.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading unconfirmed bookings:', error);
                unconfirmedList.innerHTML = `<div class="no-bookings">Error loading unconfirmed bookings: ${error.message}</div>`;
                const bulkBtns = document.getElementById('unconfirmedBulkButtons');
                if (bulkBtns) bulkBtns.style.display = 'none';
            }
        }

        // Store current booking being confirmed
        let currentConfirmingBookingId = null;

        // Show room selection modal
        async function showRoomSelection(bookingId, roomType, checkIn, checkOut) {
            currentConfirmingBookingId = bookingId;
            
            // Show booking info in modal
            const roomTypeText = roomType === 'big' ? 'Big Room' : 'Small Room';
            const checkInFormatted = formatDate(checkIn);
            const checkOutFormatted = formatDate(checkOut);
            const dateRange = checkInFormatted === checkOutFormatted 
                ? checkInFormatted 
                : `${checkInFormatted}-${checkOutFormatted}`;
            
            document.getElementById('roomSelectionInfo').innerHTML = `
                <p><strong>${roomTypeText}</strong></p>
                <p>Dates: ${dateRange}</p>
            `;
            
            // Show modal
            document.getElementById('roomSelectionModal').style.display = 'block';
            
            // Load available rooms
            await loadAvailableRooms(roomType, checkIn, checkOut);
        }

        // Load available rooms for the booking dates
        async function loadAvailableRooms(roomType, checkIn, checkOut) {
            const roomSelect = document.getElementById('roomSelect');
            roomSelect.innerHTML = '<option value="">Loading rooms...</option>';
            
            try {
                const response = await fetch(
                    `${BACKEND_URL}/admin/available-rooms?roomType=${roomType}&checkIn=${checkIn}&checkOut=${checkOut}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to load available rooms');
                }
                
                const data = await response.json();
                
                console.log('Available rooms response:', data);
                console.log('Available rooms count:', data.availableRooms?.length);
                console.log('Total rooms:', data.totalRooms);
                console.log('Booked rooms:', data.bookedRooms);
                
                if (!data.availableRooms || data.availableRooms.length === 0) {
                    roomSelect.innerHTML = '<option value="">No available rooms for these dates</option>';
                    document.getElementById('confirmRoomBtn').disabled = true;
                    console.warn('No available rooms found. Total rooms:', data.totalRooms, 'Booked rooms:', data.bookedRooms?.length || 0);
                } else {
                    roomSelect.innerHTML = '<option value="">-- Select Room --</option>' +
                        data.availableRooms.map(roomId => {
                            const parts = roomId.split('-');
                            const type = parts[0].toUpperCase();
                            const num = parts[1];
                            return `<option value="${roomId}">${type} ROOM #${num}</option>`;
                        }).join('');
                    document.getElementById('confirmRoomBtn').disabled = false;
                    console.log('Loaded', data.availableRooms.length, 'available rooms');
                }
            } catch (error) {
                console.error('Error loading available rooms:', error);
                roomSelect.innerHTML = '<option value="">Error loading rooms</option>';
                document.getElementById('confirmRoomBtn').disabled = true;
            }
        }

        // Confirm booking with selected room
        async function confirmBookingWithRoom() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoomId = roomSelect.value;
            
            if (!selectedRoomId) {
                showAdminMessage('Please select a room', 'error');
                return;
            }
            
            if (!currentConfirmingBookingId) {
                showAdminMessage('No booking selected', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/admin/confirm-booking/${currentConfirmingBookingId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: selectedRoomId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAdminMessage(data.message || 'Booking confirmed successfully', 'success');
                    
                    // Close modal
                    document.getElementById('roomSelectionModal').style.display = 'none';
                    currentConfirmingBookingId = null;
                    
                    // Refresh lists
                    loadUnconfirmedBookings();
                    loadBookings();
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    showAdminMessage(errorData.error || 'Error confirming booking', 'error');
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showAdminMessage('Error confirming booking', 'error');
            }
        }

        // Close modal
        function closeRoomSelectionModal() {
            document.getElementById('roomSelectionModal').style.display = 'none';
            currentConfirmingBookingId = null;
        }

        // Confirm all unconfirmed bookings (auto-assign first available room)
        async function confirmAllUnconfirmedBookings() {
            try {
                const response = await fetch(`${BACKEND_URL}/admin/unconfirmed-bookings`);
                if (!response.ok) throw new Error('Failed to load bookings');
                const bookings = await response.json();
                if (bookings.length === 0) {
                    showAdminMessage('No unconfirmed bookings to confirm', 'error');
                    return;
                }
                if (!confirm(`Confirm all ${bookings.length} unconfirmed booking(s)? Each will be assigned the first available room.`)) return;

                let confirmed = 0;
                let failed = 0;
                for (const booking of bookings) {
                    try {
                        const roomsResp = await fetch(
                            `${BACKEND_URL}/admin/available-rooms?roomType=${booking.roomType}&checkIn=${booking.checkIn}&checkOut=${booking.checkOut}`
                        );
                        if (!roomsResp.ok) throw new Error('No rooms');
                        const data = await roomsResp.json();
                        const roomId = data.availableRooms?.[0];
                        if (!roomId) {
                            failed++;
                            continue;
                        }
                        const confirmResp = await fetch(`${BACKEND_URL}/admin/confirm-booking/${booking.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ roomId })
                        });
                        if (confirmResp.ok) confirmed++;
                        else failed++;
                    } catch (e) {
                        failed++;
                    }
                }
                showAdminMessage(`Confirmed ${confirmed} booking(s)${failed > 0 ? `, ${failed} failed (no room available)` : ''}`, confirmed > 0 ? 'success' : 'error');
                loadUnconfirmedBookings();
                loadBookings();
            } catch (error) {
                console.error('Error confirming all:', error);
                showAdminMessage('Error confirming bookings', 'error');
            }
        }

        // Delete all unconfirmed bookings
        async function deleteAllUnconfirmedBookings() {
            try {
                const response = await fetch(`${BACKEND_URL}/admin/unconfirmed-bookings`);
                if (!response.ok) throw new Error('Failed to load bookings');
                const bookings = await response.json();
                if (bookings.length === 0) {
                    showAdminMessage('No unconfirmed bookings to delete', 'error');
                    return;
                }
                if (!confirm(`Delete all ${bookings.length} unconfirmed booking(s)?`)) return;

                let deleted = 0;
                for (const booking of bookings) {
                    const delResp = await fetch(`${BACKEND_URL}/admin/booking/${booking.id}`, { method: 'DELETE' });
                    if (delResp.ok) deleted++;
                }
                showAdminMessage(`Deleted ${deleted} booking(s)`, 'success');
                loadUnconfirmedBookings();
                loadBookings();
            } catch (error) {
                console.error('Error deleting all:', error);
                showAdminMessage('Error deleting bookings', 'error');
            }
        }

        // Delete an unconfirmed booking
        async function deleteUnconfirmedBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this unconfirmed booking?')) {
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/admin/booking/${bookingId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAdminMessage(data.message || 'Booking deleted successfully', 'success');
                    loadUnconfirmedBookings(); // Refresh unconfirmed list
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    showAdminMessage(errorData.error || 'Error deleting booking', 'error');
                }
            } catch (error) {
                console.error('Error deleting unconfirmed booking:', error);
                showAdminMessage('Error deleting booking', 'error');
            }
        }

        // Delete all admin bookings
        async function deleteAllAdminBookings() {
            try {
                const response = await fetch(`${BACKEND_URL}/admin/bookings`);
                if (!response.ok) throw new Error('Failed to load bookings');
                const bookings = await response.json();
                if (bookings.length === 0) {
                    showAdminMessage('No bookings to delete', 'error');
                    return;
                }
                if (!confirm(`Delete all ${bookings.length} booking(s)?`)) return;

                let deleted = 0;
                for (const booking of bookings) {
                    const delResp = await fetch(`${BACKEND_URL}/admin/booking/${booking.id}`, { method: 'DELETE' });
                    if (delResp.ok) deleted++;
                }
                showAdminMessage(`Deleted ${deleted} booking(s)`, 'success');
                loadBookings();
                loadUnconfirmedBookings();
            } catch (error) {
                console.error('Error deleting all:', error);
                showAdminMessage('Error deleting bookings', 'error');
            }
        }

        // Delete booking
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking?')) {
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/admin/booking/${bookingId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAdminMessage(data.message || 'Booking deleted successfully', 'success');
                    loadBookings();
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    showAdminMessage(errorData.error || 'Error deleting booking', 'error');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showAdminMessage('Error deleting booking', 'error');
            }
        }

        // Make deleteBooking available globally
        window.deleteBooking = deleteBooking;

        // Show admin message
        function showAdminMessage(text, type) {
            const msgEl = document.getElementById('adminMessage');
            if (msgEl) {
                msgEl.textContent = text;
                msgEl.className = `admin-message ${type}`;
                // Keep info messages longer (5 seconds), others 3 seconds
                const timeout = type === 'info' ? 5000 : 3000;
                setTimeout(() => {
                    msgEl.textContent = '';
                    msgEl.className = 'admin-message';
                }, timeout);
            }
        }

        // Save unavailability
        document.addEventListener('DOMContentLoaded', function() {
            // Modal event listeners
            const modal = document.getElementById('roomSelectionModal');
            const closeModal = document.querySelector('.close-modal');
            const confirmRoomBtn = document.getElementById('confirmRoomBtn');
            const cancelRoomBtn = document.getElementById('cancelRoomBtn');
            
            if (closeModal) {
                closeModal.addEventListener('click', closeRoomSelectionModal);
            }
            
            if (cancelRoomBtn) {
                cancelRoomBtn.addEventListener('click', closeRoomSelectionModal);
            }
            
            if (confirmRoomBtn) {
                confirmRoomBtn.addEventListener('click', confirmBookingWithRoom);
            }
            
            // Close modal when clicking outside
            if (modal) {
                window.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeRoomSelectionModal();
                    }
                });
            }
            
            const saveBtn = document.getElementById('adminSaveBtn');
            
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const roomId = document.getElementById('adminRoomSelect').value;
                    const checkIn = adminCheckInPicker?.selectedDates[0];
                    const checkOut = adminCheckOutPicker?.selectedDates[0];
                    
                    if (!roomId) {
                        showAdminMessage('Please select a room', 'error');
                        return;
                    }
                    
                    if (!checkIn || !checkOut) {
                        showAdminMessage('Please select both check-in and check-out dates', 'error');
                        return;
                    }
                    
                    if (checkOut <= checkIn) {
                        showAdminMessage('Check-out date must be after check-in date', 'error');
                        return;
                    }
                    
                    // Format dates in local timezone to avoid UTC conversion issues
                    const checkInStr = formatDateForBackend(checkIn);
                    const checkOutStr = formatDateForBackend(checkOut);
                    
                    try {
                        const response = await fetch(`${BACKEND_URL}/admin/book-room`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ roomId, checkIn: checkInStr, checkOut: checkOutStr })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            showAdminMessage(data.message || 'Room marked as unavailable', 'success');
                            adminCheckInPicker.clear();
                            adminCheckOutPicker.clear();
                            loadBookings(); // Refresh bookings list
                        } else {
                            showAdminMessage(data.error || 'Error saving booking', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showAdminMessage('Error connecting to server. Make sure backend is running.', 'error');
                    }
                });
            }
        });

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = '';
            
            // Check credentials
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Store authentication in sessionStorage
                sessionStorage.setItem(AUTH_KEY, 'true');
                // Also store in localStorage for cross-window sharing (temporary token)
                localStorage.setItem('admin_auth_token', Date.now().toString());
                showAdminContent();
            } else {
                errorMessage.textContent = 'Invalid username or password';
            }
        });

        // Handle restart backend
        const restartBtn = document.getElementById('restartBtn');
        if (restartBtn) {
            restartBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to restart the backend server? This will temporarily disconnect all users.')) {
                    return;
                }
                
                try {
                    showAdminMessage('Restarting backend server...', 'info');
                    const response = await fetch(`${BACKEND_URL}/admin/restart`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        showAdminMessage(data.message || 'Backend restart initiated. Please wait a few seconds...', 'success');
                        
                        // Update status immediately to show restarting
                        const statusEl = document.getElementById('serverStatus');
                        const textEl = statusEl?.querySelector('.status-text');
                        if (textEl) {
                            textEl.textContent = 'Restarting...';
                        }
                        
                        // Check status after 10 seconds
                        setTimeout(() => {
                            checkServerStatus();
                        }, 10000);
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        showAdminMessage(errorData.error || 'Error restarting server', 'error');
                    }
                } catch (error) {
                    console.error('Error restarting server:', error);
                    showAdminMessage('Error connecting to server. Server may be restarting...', 'info');
                    
                    // Update status immediately to show restarting
                    const statusEl = document.getElementById('serverStatus');
                    const textEl = statusEl?.querySelector('.status-text');
                    if (textEl) {
                        textEl.textContent = 'Restarting...';
                    }
                    
                    // Check status after 10 seconds
                    setTimeout(() => {
                        checkServerStatus();
                    }, 10000);
                }
            });
        }
        
        // Check server status and update display
        async function checkServerStatus() {
            const statusEl = document.getElementById('serverStatus');
            const indicatorEl = statusEl?.querySelector('.status-indicator');
            const textEl = statusEl?.querySelector('.status-text');
            
            if (!statusEl || !indicatorEl || !textEl) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/admin/status`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update status display
                    statusEl.className = 'server-status online';
                    indicatorEl.className = 'status-indicator online';
                    textEl.textContent = `Online • Port ${data.port} • Uptime: ${data.uptime}`;
                    
                    // Add tooltip with more details
                    statusEl.title = `Server Status: Online\nPort: ${data.port}\nUptime: ${data.uptime}\nMemory: ${data.memory.used}MB / ${data.memory.total}MB\nNode: ${data.nodeVersion}\nPlatform: ${data.platform}`;
                } else {
                    // Server responded but with error
                    statusEl.className = 'server-status offline';
                    indicatorEl.className = 'status-indicator offline';
                    textEl.textContent = 'Error';
                    statusEl.title = 'Server returned an error';
                }
            } catch (error) {
                // Server is offline or unreachable
                statusEl.className = 'server-status offline';
                indicatorEl.className = 'status-indicator offline';
                textEl.textContent = 'Offline';
                statusEl.title = 'Cannot connect to server. Make sure backend is running on port 3001.';
            }
        }

        // Handle menu button - open menu management in new window
        const menuBtn = document.getElementById('menuBtn');
        if (menuBtn) {
            menuBtn.addEventListener('click', () => {
                // Open in new tab - session cookies should be shared if same origin
                const menuWindow = window.open(`${BACKEND_URL}/admin-menu.html`, '_blank');
                // If window fails to open (popup blocked), fallback to same window
                if (!menuWindow || menuWindow.closed || typeof menuWindow.closed === 'undefined') {
                    window.location.href = `${BACKEND_URL}/admin-menu.html`;
                }
            });
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            // Clear authentication
            sessionStorage.removeItem(AUTH_KEY);
            localStorage.removeItem('admin_auth_token'); // Clear cross-window token
            if (adminCheckInPicker) {
                adminCheckInPicker.destroy();
                adminCheckInPicker = null;
            }
            if (adminCheckOutPicker) {
                adminCheckOutPicker.destroy();
                adminCheckOutPicker = null;
            }
            showLoginForm();
            document.getElementById('loginForm').reset();
        });

        // Check auth on page load
        checkAuth();
    </script>
</body>
</html>
